name: update customer info

on:
  workflow_dispatch:
    inputs:
      org_name:
        description: "Organization name"
      billing_account_id:
        description: "Billing account ID"
      external_id_autopilot:
        description: "External ID for Autopilot"
      external_id_saving_bot:
        description: "External ID for SavingBot"
      autopilot_version:
        description: "Autopilot version"
  workflow_call:
    # Map the workflow outputs to job outputs
    outputs:
      org_name:
        description: "Org name"
        value: ${{ github.event.inputs.org_name }}
jobs:
  hello:
    # Map the job outputs to step outputs
    runs-on: ubuntu-latest
    permissions:
      id-token: write # This is required for requesting the JWT
      contents: write # This is required for actions/checkout & creating pull requests
      pull-requests: write # This is required for creating pull requests
    steps:
    - id: step1
      run: echo "firstword=hello" >> $GITHUB_OUTPUT
    - id: step2
      run: echo "secondword=world" >> $GITHUB_OUTPUT
    - name: Checkout repo
      uses: actions/checkout@v4
    - name: Update Customer Info
      run: echo "| ${{ github.event.inputs.org_name }} | | ${{ github.event.inputs.billing_account_id }} | ${{ github.event.inputs.external_id_autopilot }} | | ${{ github.event.inputs.autopilot_version }}||||" >> assets/data/CustomerInfo.md
    - name: Get Time
      id: time
      uses: nanzm/get-time-action@master
      with:
        format: "YYYY-MM-DD-HH-mm-ss"
    - name: Create PR
      env:
        BRANCH_NAME: update-customer-${{ github.event.inputs.org_name }}-${{ steps.time.outputs.time }}
        GH_TOKEN: ${{ github.token }}
      run: |
        git config --global user.email CustomerInfoUpdater@auto.onboarding
        git config --global user.name customer-info-updater
        git checkout -b "$BRANCH_NAME"
        git add .
        if [[ "$(git status --porcelain|wc -l)" -gt 0 ]]; then
          git commit --message "Onboarding New Customer ${{ github.event.inputs.org_name }}"
          git push -u origin HEAD:$BRANCH_NAME
          gh pr create --base main --head $BRANCH_NAME --title "Onboarding New Customer ${{ github.event.inputs.org_name }}" --body "Merge this PR and start the auto-onboarding workflow."
        fi